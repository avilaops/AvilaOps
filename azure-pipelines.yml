# Azure DevOps Pipeline para Azure Static Web Apps (Next.js SSR)
# Colocar este arquivo na raiz do repositório.
# Necessário criar Service Connection (Azure Resource Manager) e variável secreta STATIC_WEB_APPS_TOKEN.

trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  NodeVersion: '20.x'
  AppLocation: '.'
  OutputLocation: '.next'

stages:
  - stage: Build
    displayName: Build
    jobs:
      - job: BuildJob
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(NodeVersion)
            displayName: 'Use Node $(NodeVersion)'

          - script: npm ci
            displayName: 'Instalar dependências'

          - script: npm run lint || echo "Ignorando warnings de lint"
            displayName: 'Lint'

          - script: npm run build
            displayName: 'Build Next.js'

          - publish: $(OutputLocation)
            artifact: nextBuild
            displayName: 'Publicar artefato .next'

  - stage: Deploy
    displayName: Deploy Static Web App
    dependsOn: Build
    jobs:
      - job: DeployJob
        steps:
          - download: current
            artifact: nextBuild
          - task: Bash@3
            name: UploadSWA
            env:
              DEPLOYMENT_TOKEN: $(STATIC_WEB_APPS_TOKEN)
            inputs:
              targetType: 'inline'
              script: |
                echo "Instalando CLI SWA";
                npm install -g @azure/static-web-apps-cli@1;
                echo "Iniciando upload";
                swa deploy --deployment-token $DEPLOYMENT_TOKEN --env production --app-location $(AppLocation) --output-location $(OutputLocation)
            displayName: 'Deploy para Azure Static Web Apps'