## Deploy em Azure – avilaops.com

Este guia cobre:

1. Escolha de serviço
2. Provisionamento do Static Web App
3. Workflow CI/CD
4. Domínio personalizado (avilaops.com)
5. Observabilidade e futuras integrações Azure AI
6. Infra as Code (Bicep opcional)

### 1. Serviço Escolhido

Usamos **Azure Static Web Apps (SWA)** com suporte a **Next.js SSR**. Benefícios:

- Build automático e edge global
- Easy custom domain e certificados gerenciados
- Futuro: APIs (Functions) na mesma superfície

Alternativas se requisitos mudarem:

- App Service (mais controle de runtime e WebSockets pesados)
- Container Apps (microserviços, Dapr, escala horizontal dinâmica)

### 2. Provisionar o Static Web App

Via Portal: Criar recurso "Static Web App" (SKU Standard) apontando para o repositório GitHub `avilaops/avilaops-com`, branch `main`, localização próxima aos usuários (ex: East US ou Brazil South quando disponível para SWA).

Via CLI:

```powershell
az staticwebapp create `
  --name avilaops-com `
  --resource-group rg-avilaops `
  --sku Standard `
  --location eastus2 `
  --source https://github.com/avilaops/avilaops-com `
  --branch main `
  --login-with-github `
  --app-location . `
  --output-location .next
```

Observação: `--output-location .next` para Next.js SSR.

### 3. CI/CD

Arquivos de workflow:

- `.github/workflows/azure-static-web-apps.yml` — build + deploy do site Next.js para o Static Web Apps.
- `.github/workflows/azure-infra-deploy.yml` — provisionamento IaC (Bicep) com What-If + Deploy.

Secrets necessários no GitHub:

- `AZURE_STATIC_WEB_APPS_API_TOKEN`: token de implantação do SWA (Portal do recurso > Deployment Token).
- `AZURE_CREDENTIALS`: credenciais do Service Principal em JSON (para a etapa de IaC), no formato:

  ```json
  {
    "clientId": "<APP_ID>",
    "clientSecret": "<PASSWORD>",
    "subscriptionId": "<SUBSCRIPTION_ID>",
    "tenantId": "<TENANT_ID>"
  }
  ```

Observação: O workflow gerado automaticamente pelo Portal (`azure-static-web-apps-nice-dune-*.yml`) foi desativado para evitar deploy duplo. Use apenas `azure-static-web-apps.yml`.

#### 3A. Azure DevOps (Alternativa sem GitHub Actions)

Arquivo adicionado: `azure-pipelines.yml`.

Passos:

1. Criar Service Connection (Azure Resource Manager) para acesso se futuramente quiser automatizar criação de recursos.
2. Criar variável secreta `STATIC_WEB_APPS_TOKEN` no Library ou variável de pipeline contendo Deployment Token do SWA.
3. Pipeline possui dois stages: Build (gera artefato `.next`) e Deploy (usa CLI `swa deploy`).
4. Ajustar NodeVersion se necessário.
5. Para adicionar testes, inserir etapa antes do build: `npm test` (quando houver suite).

Exemplo de execução manual (Classic UI): criar pipeline apontando para `azure-pipelines.yml` na branch `main`.

### 4. Domínio Personalizado (avilaops.com)

Passos:

1. Portal SWA > Custom domains > Add.
2. Escolher `avilaops.com` (apex) e `www.avilaops.com` se desejar.
3. Validação DNS:

- Apex: criar **A record** apontando para endereço fornecido ou usar CNAME flattening conforme seu DNS provider. Alguns provedores permitem CNAME em apex – se possível, use CNAME para `<auto-generated>.azurestaticapps.net`.
- Subdomínio (www): criar CNAME `www` -> `<auto-generated>.azurestaticapps.net`.
- TXT de verificação se solicitado.

Após propagação, SWA emite certificado automaticamente (pode levar até 15 minutos).

CLI exemplo para adicionar hostname:

```powershell
az staticwebapp hostname set `
  --name avilaops-com `
  --resource-group rg-avilaops `
  --hostname avilaops.com
```

### 5. Observabilidade & Azure AI (Futuro)

Provisionar recursos:

- Azure AI Foundry Project (workspace unificado)
- Azure OpenAI (modelos GPT para terminal inteligente / narrativa)
- Cosmos DB (memória de sessões, vetores no futuro) – escolher chave de partição `userId`.
- Blob Storage (assets dinâmicos, logs de métricas brutas)
- Application Insights (telemetria SWA/API Functions)

Integração básica futura (dotenv): ver `.env.local.example`.

### 6. Infra as Code (Opcional Bicep)

Arquivos:

- `infra/staticwebapp.bicep` cria o recurso base do SWA (repo URL e branch já parametrizados)
- `infra/azure-ai-resources.bicep` prepara recursos de suporte (Storage, Key Vault, Insights, Cosmos, OpenAI)

Deployment manual via CLI:

```powershell
az group create -n rg-avilaops -l eastus2
az deployment group create -g rg-avilaops -f infra/staticwebapp.bicep -p repoUrl="https://github.com/avilaops/avilaops-com" branch="main"

# (Opcional) Recursos de suporte:
TENANT_ID=$(az account show --query tenantId -o tsv)
az deployment group create -g rg-avilaops -f infra/azure-ai-resources.bicep -p prefix="avilaops" tenantId="$TENANT_ID"
```

### 7. Variáveis de Ambiente

Usar Portal SWA > Configuration ou arquivo `.env` local para desenvolvimento.

### 8. Checklist Pós-Deploy

| Item | Status |
|------|--------|
| SWA criado | ☐ |
| Token adicionado no GitHub | ☐ |
| Workflow rodou e publicou | ☐ |
| Domínio avilaops.com validado | ☐ |
| Certificado emitido | ☐ |
| Observabilidade (App Insights) | ☐ |
| Recursos Azure AI provisionados | ☐ |
| Cosmos DB configurado | ☐ |
| Documentação atualizada | ☐ |

### 9. Troubleshooting

- 404 após deploy: confirmar `output_location` e versão Next.
- Domínio não valida: checar propagação DNS (dig / nslookup) e registros corretos.
- Erros SSR específicos: ver logs no Portal (Diagnose & Solve Problems) e se Node version >= 18.

### 10. Próximos Passos

- Adicionar API Functions para métricas em tempo real.
- Implementar memória conversacional usando Cosmos DB + vetor (quando necessário).
- Monitorar custos e ajustar SKU.

---

Atualizado em: 2025-11-02.
