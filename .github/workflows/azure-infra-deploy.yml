name: Azure Infra (Bicep) - WhatIf + Deploy

on:
    workflow_dispatch:
        inputs:
            resourceGroup:
                description: "Resource Group name"
                required: true
                default: "rg-avilaops"
            location:
                description: "Azure Region"
                required: true
                default: "eastus2"
    push:
        branches: [main]
        paths:
            - "infra/**/*.bicep"

permissions:
    id-token: write
    contents: read

jobs:
    whatif:
        runs-on: ubuntu-latest
        env:
            RG_NAME: ${{ github.event.inputs.resourceGroup || 'rg-avilaops' }}
            LOCATION: ${{ github.event.inputs.location || 'eastus2' }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Azure Login
              uses: azure/login@v2
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Create resource group (idempotent)
              run: |
                  az group create --name "$RG_NAME" --location "$LOCATION"

            - name: What-If staticwebapp.bicep
              run: |
                  az deployment group what-if \
                    --resource-group "$RG_NAME" \
                    --template-file infra/staticwebapp.bicep \
                    --parameters repoUrl="https://github.com/${{ github.repository }}" branch="${{ github.ref_name }}"

            - name: What-If azure-ai-resources.bicep
              run: |
                  TENANT_ID=$(az account show --query tenantId -o tsv)
                  az deployment group what-if \
                    --resource-group "$RG_NAME" \
                    --template-file infra/azure-ai-resources.bicep \
                    --parameters prefix="avilaops" tenantId="$TENANT_ID"

    deploy:
        needs: whatif
        runs-on: ubuntu-latest
        environment: production
        env:
            RG_NAME: ${{ github.event.inputs.resourceGroup || 'rg-avilaops' }}
            LOCATION: ${{ github.event.inputs.location || 'eastus2' }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Azure Login
              uses: azure/login@v2
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Ensure resource group
              run: |
                  az group create --name "$RG_NAME" --location "$LOCATION"

            - name: Deploy staticwebapp.bicep
              run: |
                  az deployment group create \
                    --resource-group "$RG_NAME" \
                    --template-file infra/staticwebapp.bicep \
                    --parameters repoUrl="https://github.com/${{ github.repository }}" branch="${{ github.ref_name }}"

            - name: Deploy azure-ai-resources.bicep
              run: |
                  TENANT_ID=$(az account show --query tenantId -o tsv)
                  az deployment group create \
                    --resource-group "$RG_NAME" \
                    --template-file infra/azure-ai-resources.bicep \
                    --parameters prefix="avilaops" tenantId="$TENANT_ID"
